substitutions:
  _CLOUDSDK_COMPUTE_ZONE: australia-southeast1-b
  _CLOUDSDK_CONTAINER_CLUSTER: anz-test-cluster
  _APP_NAME: anz-test

steps:
  - id: "Go Dependencies"
    name: mirror.gcr.io/library/golang
    args: ["go", "mod", "download"]
    env:
    - GO111MODULE=on
    - GOPROXY=https://proxy.golang.org
    volumes:
    - name: go-modules
      path: /go

  - id: "Go Tests"
    name: mirror.gcr.io/library/golang
    args: ["go", "test", "./..."]
    env:
    - GO111MODULE=on
    volumes:
    - name: go-modules
      path: /go

  - id: "Go Security"
    name: securego/gosec
    args: [".", "/"]
    volumes:
    - name: go-modules
      path: /go

  - id: "Build Image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "./build.sh"
    env:
    - PROJECT_ID=$PROJECT_ID
    - CLOUDBUILD=true

  - id: "Push Image"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/${_APP_NAME}"]

  - id: "Deploy to Cluster"
    name: "gcr.io/cloud-builders/gke-deploy:stable"
    args:
    - run
    - --filename=kube/
    - --image=gcr.io/$PROJECT_ID/${_APP_NAME}:latest
    - --location=${_CLOUDSDK_COMPUTE_ZONE}
    - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}

  # - id: "Deploy to Cluster"
  #   name: 'gcr.io/cloud-builders/kubectl'
  #   args: ['set', 'image', 'deployment/${_APP_NAME}', 'container=gcr.io/$PROJECT_ID/${_APP_NAME}']
  #   env:
  #   - 'CLOUDSDK_COMPUTE_ZONE=${_CLOUDSDK_COMPUTE_ZONE}'
  #   - 'CLOUDSDK_CONTAINER_CLUSTER=${_CLOUDSDK_CONTAINER_CLUSTER}'

