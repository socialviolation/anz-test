substitutions:
  _CLOUDSDK_COMPUTE_ZONE: australia-southeast1-b
  _CLOUDSDK_CONTAINER_CLUSTER: anz-test-cluster
  _APP_NAME: anz-test

steps:
  - id: "Go Dependencies"
    name: mirror.gcr.io/library/golang
    args: ["go", "mod", "download"]
    dir: task-1
    env:
    - GO111MODULE=on
    - GOPROXY=https://proxy.golang.org
    volumes:
    - name: go-modules
      path: /go

  - id: "Go Tests"
    name: mirror.gcr.io/library/golang
    args: ["go", "test", "./..."]
    dir: task-1
    env:
    - GO111MODULE=on
    volumes:
    - name: go-modules
      path: /go

  - id: "Go Security"
    name: securego/gosec
    args: [".", "/"]
    dir: task-1
    volumes:
    - name: go-modules
      path: /go

  - id: "Build Image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: "./build.sh"
    dir: task-1
    env:
    - PROJECT_ID=$PROJECT_ID
    - CLOUDBUILD=true

  - id: "Push Image"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "gcr.io/$PROJECT_ID/${_APP_NAME}"]
    dir: task-1

  - id: "Deploy to Cluster"
    name: "gcr.io/cloud-builders/gke-deploy:stable"
    dir: task-2
    args:
    - run
    - --filename=.
    - --image=gcr.io/$PROJECT_ID/${_APP_NAME}:latest
    - --location=${_CLOUDSDK_COMPUTE_ZONE}
    - --cluster=${_CLOUDSDK_CONTAINER_CLUSTER}

images: ["gcr.io/$PROJECT_ID/${_APP_NAME}"]
